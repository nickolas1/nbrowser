/*! nbrowser 11-09-2014 */
var launchIntegrator=function(){setBackgroundImage(),generateStars(),"keplerP"!=theme&&equilibrateStars(),calcAccels(),starsvg=initializeStarPlot(),integrateStars()},selectKepler=function(){nStars=32,theme="kepler",$(".selector.selected").removeClass("selector selected").addClass("selector"),$("#keplerChooser").removeClass("selector").addClass("selector selected"),$("#starLayer").empty(),launchIntegrator()},selectJeffers=function(){nStars=24,theme="jeffers",$(".selector.selected").removeClass("selector selected").addClass("selector"),$("#jeffersChooser").removeClass("selector").addClass("selector selected"),$("#starLayer").empty(),starApexes=[],apexStorage=[],launchIntegrator()},selectKeplerPlanet=function(){nStars=16,theme="keplerP",$(".selector.selected").removeClass("selector selected").addClass("selector"),$("#keplerPlanetChooser").removeClass("selector").addClass("selector selected"),$("#starLayer").empty(),launchIntegrator()},theme="jeffers",nStars=16,masses,pos,vel,acc,starsvg,starApexes=[],apexStorage=[],oldpos=[],integrateTimer,w=700,h=390,x=d3.scale.linear().range([0,w]),y=d3.scale.linear().range([h,0]),lineFunction=d3.svg.line().x(function(a){return x(a[0])}).y(function(a){return y(a[1])}).interpolate("linear");$(function(){var a=$("#about");a.poptrox(),initializeSvgLayers(),setBackgroundImage(),generateStars(),"keplerP"!==theme&&equilibrateStars(),calcAccels(),starsvg=initializeStarPlot(),integrateStars()});var initializeSvgLayers=function(){var a=d3.select("#nbodycanvas").append("svg").attr("width",w).attr("height",h).attr("id","svg");a.append("image").attr("width",w).attr("height",h).attr("id","backgroundImage"),a.append("g").attr("width",w).attr("height",h).attr("id","starLayer");var b=a.append("defs");b.append("filter").attr("id","gaussblur2").append("feGaussianBlur").attr("in","SourceGraphic").attr("stdDeviation",2),b.append("filter").attr("id","gaussblur3").append("feGaussianBlur").attr("in","SourceGraphic").attr("stdDeviation",3)},generateStars=function(){"keplerP"!==theme?(masses=generateMasses(nStars),pos=generatePositions(nStars),acc=generatePositions(nStars),vel=generateVelocities(nStars,pos)):"keplerP"===theme&&(pos=[],vel=[],masses=generateMassesP(nStars),generateBodiesP(nStars),acc=generatePositions(nStars))},equilibrateStars=function(){var a,b,c,d,e=calcCM(nStars,masses,pos,vel),f=calcKineticEnergy(nStars,masses,vel),g=calcPotentialEnergy(nStars,masses,pos);for(c=0;nStars>c;c++)for(d=0;3>d;d++)pos[c][d]-=e[0][d],vel[c][d]-=e[1][d];for(b=Math.sqrt(-.5*g/f),c=0;nStars>c;c++)for(d=0;3>d;d++)vel[c][d]*=b;for(a=-.25/(f*b*b+g),b=Math.sqrt(a),c=0;nStars>c;c++)for(d=0;3>d;d++)pos[c][d]/=a,vel[c][d]*=b},integrateStars=function(){var a=64,b=8,c=0,d=.002;"keplerP"===theme&&(a=64,b=8,d=.02);var e=0;clearInterval(integrateTimer),integrateTimer=setInterval(function(){leapfrogStep(d),e++,c++,e===b&&(transitionStars(125,c),e=0)},1e3/a)},leapfrogStep=function(a){kickStars(.5*a),driftStars(a),calcAccels(),kickStars(.5*a)},kickStars=function(a){var b,c;for(b=0;nStars>b;b++)for(c=0;3>c;c++)vel[b][c]+=acc[b][c]*a},driftStars=function(a){var b,c;for(b=0;nStars>b;b++)for(c=0;3>c;c++)pos[b][c]+=vel[b][c]*a},calcAccels=function(){var a,b,c,d,e,f,g=[0,0,0];for(d=0;nStars>d;d++)for(f=0;3>f;f++)acc[d][f]=0;for(d=0;nStars-1>d;d++)for(e=d+1;nStars>e;e++){for(a=0,f=0;3>f;f++)g[f]=pos[e][f]-pos[d][f],a+=g[f]*g[f];for(b=a*Math.sqrt(a)+1e-7,f=0;3>f;f++)c=g[f]/b,acc[d][f]+=c*masses[e],acc[e][f]+=-c*masses[d]}},generateMassesP=function(a){var b,c=2.3,d=3,e=1,f=c-1,g=1/Math.pow(d,f),h=(g-1/Math.pow(e,f))/(a/4-1),i=1/f,j=[],k=0;for(b=0;a/4>b;b++){var l=g-b*h;mass=1/Math.pow(l,i),k+=mass,j.push(mass)}for(b=a/4;a>b;b++)mass=.001,k+=mass,j.push(mass);for(b=0;a>b;b++)j[b]/=k;return j},generateBodiesP=function(a){var b,c,d,e,f,g,h=[[1.2,1,40],[-1,-1,20],[-1.3,.8,0],[1,-.9,-20]],i=[[.1,-.3,0],[-.4,.3,0],[.5,.2,0],[-.2,-.2,0]],j=.3;for(g=0;a/4>g;g++)e=Math.random(),f=Math.random(),d=h[g][2],b=h[g][0]+(.5-e)*j,c=h[g][1]+(.5-f)*j,velx=.05*i[g][0],vely=.05*i[g][1],velz=.05*i[g][2],pos.push([b,c,d]),vel.push([velx,vely,velz]);var k,l,m,n,o,p,q,r,s=0,t=0,u=[.4,.3,.25,.2];for(g=a/4;a>g;g++)0===s&&(l=Math.PI*(115-12*Math.random())/180,k=[1+.1*(.5-Math.random()),1.5+.1*(.5-Math.random()),2.1+.1*(.5-Math.random())],console.log("incbase ",l),o=2*Math.PI*Math.random()),m=l,n=.05*Math.random(),p=2*Math.PI*Math.random(),q=2*Math.PI*Math.random(),r=kepToCart(k[s]*u[t],n,m,o,p,q,masses[g]+masses[t]),pos.push([r[0]+pos[t][0],r[1]+pos[t][1],r[2]+pos[t][2]]),vel.push([r[3],r[4],r[5]]),s++,3===s&&(s=0,t++)},kepToCart=function(a,b,c,d,e,f,g){E=eccentricAnomoly(f,b);var h=Math.cos(e)*Math.cos(d)-Math.sin(e)*Math.cos(c)*Math.sin(d),i=Math.cos(e)*Math.sin(d)+Math.sin(e)*Math.cos(c)*Math.cos(d),j=Math.sin(e)*Math.sin(c),k=-Math.sin(e)*Math.cos(d)-Math.cos(e)*Math.cos(c)*Math.sin(d),l=-Math.sin(e)*Math.sin(d)+Math.cos(e)*Math.cos(c)*Math.cos(d),m=Math.cos(e)*Math.sin(c),n=a*(Math.cos(E)-b),o=a*Math.sqrt(1-b*b)*Math.sin(E),p=Math.sqrt(g/(a*a*a))/(1-b*Math.cos(E)),q=-a*Math.sin(E),r=a*Math.sqrt(1-b*b)*Math.cos(E),s=[n*h+o*k,n*i+o*l,n*j+o*m,p*(q*h+r*k),p*(q*i+r*l),p*(q*j+r*m)];return s},eccentricAnomoly=function(a,b){for(var c=a,d=1e-10,e=c-(c-b*Math.sin(c)-a)/(1-b*Math.cos(c));Math.abs(e-c)>d;)c=e,e=c-(c-b*Math.sin(c)-a)/(1-b*Math.cos(c));return e},generateMasses=function(a){var b,c,d=2.3,e=10,f=1,g=d-1,h=1/Math.pow(e,g),i=(h-1/Math.pow(f,g))/(nStars-1),j=1/g,k=[],l=0;for(b=0;a>b;b++)c=h-b*i,mass=1/Math.pow(c,j),l+=mass,k.push(mass);for(b=0;a>b;b++)k[b]/=l;return k},generatePositions=function(a){var b,c,d,e,f,g,h,i,j=[];for(b=0;a>b;b++){for(c=60;c>6;){for(d=1e-11;1e-10>d;)d=Math.random();c=Math.pow(Math.pow(d,-.6666667)-1,-.5)}e=Math.random(),f=Math.random(),i=(1-2*e)*c,g=Math.sqrt(c*c-i*i)*Math.cos(2*Math.PI*f),h=Math.sqrt(c*c-i*i)*Math.sin(2*Math.PI*f),j.push([g,h,i])}return j},generateVelocities=function(a,b){var c,d,e,f,g,h,i,j,k,l,m,n=[];for(c=0;a>c;c++){for(e=0,d=0;3>d;d++)e+=b[c][d]*b[c][d];for(e=Math.sqrt(e),f=1,g=1e3,h=1;g>10*h;)f=Math.random(),g=Math.random(),h=2*f*Math.pow(1-f*f,3.5);j=f*Math.SQRT2/Math.pow(1+e*e,.25),h=Math.random(),i=Math.random(),m=(1-2*h)*j,k=Math.sqrt(j*j-m*m)*Math.cos(2*Math.PI*i),l=Math.sqrt(j*j-m*m)*Math.sin(2*Math.PI*i),n.push([.1*k,.1*l,.1*m])}return n},calcCM=function(a,b,c,d){var e,f,g=[[0,0,0],[0,0,0]];for(e=0;a>e;e++)for(f=0;3>f;f++)g[0][f]+=b[e]*c[e][f],g[1][f]+=b[e]*d[e][f];return g};calcKineticEnergy=function(a,b,c){var d,e,f,g=0;for(e=0;a>e;e++){for(d=0,f=0;3>f;f++)d+=c[e][f]*c[e][f];g+=.5*b[e]*d}return g},calcPotentialEnergy=function(a,b,c){var d,e,f,g,h,i,j,k,l=[0,0,0],m=0;for(i=0;a>i;i++)for(e=c[i],f=b[i],j=i;a>j;j++)if(i!=j){for(g=c[j],h=b[j],d=0,k=0;3>k;k++)l[k]=g[k]-e[k],d+=l[k]*l[k];m-=f*h/Math.sqrt(d)}return m};var initializeStarPlot=function(){if("jeffers"===theme){var a,b,c=12,d=c*h/w;x.domain([-8,4]),y.domain([2.5-d,2.5]);var e=[[-2.5,-.5],[-2,-6.5],[1,-1.6],[2,-7.5],[2.5,-.5],[5,2],[2,1.5],[.5,5.5],[-1.5,1],[-5.5,.7]];for(a=0;nStars>a;a++){var f,g,i,j=[],k=[],l=7e-4/d3.min(masses);for(f=Math.random()<.5?1:-1,b=0;b<e.length;b++)g=(.4*Math.random()-.2+1)*f,i=.4*Math.random()-.2+1,j.push([Math.sqrt(masses[a]*l)*e[b][0]*g+pos[a][0],Math.sqrt(masses[a]*l)*e[b][1]*i+pos[a][1]]),k.push([Math.sqrt(masses[a]*l)*e[b][0]*g,Math.sqrt(masses[a]*l)*e[b][1]*i]);j.push([j[0][0],j[0][1]]),k.push([k[0][0],k[0][1]]),starApexes.push(j),apexStorage.push(k)}d3.select("#starLayer").selectAll(".star").data(starApexes).enter().append("path").attr("d",lineFunction).attr("class","jeffers star")}else if("kepler"===theme){var c=5,d=c*h/w;x.domain([-c/2,c/2]),y.domain([-d/2,d/2]);var m=["rgb(221, 56, 0)","rgb(221, 137, 20)","rgb(234, 225, 89)","rgb(106, 137, 234)"],n=d3.scale.linear().domain(d3.range(0,1.01,1/(m.length-1))).range(m),o=d3.scale.log().domain(d3.extent(masses)).range([0,1]);d3.select("#starLayer").selectAll(".star.diffuse").data(pos).enter().append("circle").attr("cx",function(a){return x(a[0])}).attr("cy",function(a){return y(a[1])}).attr("r",function(a,b){return 30*Math.sqrt(masses[b]/d3.max(masses))}).attr("fill",function(a,b){return n(o(masses[b]))}).attr("opacity",.8).attr("class","kepler star diffuse").attr("filter","url(#gaussblur2)"),d3.select("#starLayer").selectAll(".star.solid").data(pos).enter().append("circle").attr("cx",function(a){return x(a[0])}).attr("cy",function(a){return y(a[1])}).attr("r",function(a,b){return 27*Math.sqrt(masses[b]/d3.max(masses))}).attr("fill",function(a,b){return n(o(masses[b]))}).attr("opacity",.5).attr("class","kepler star solid"),d3.select("#starLayer").selectAll(".star.compact").data(pos).enter().append("circle").attr("cx",function(a){return x(a[0])}).attr("cy",function(a){return y(a[1])}).attr("r",function(a,b){return 7.5*Math.sqrt(masses[b]/d3.max(masses))}).attr("fill","rgba(255, 255, 255, .9)").attr("class","kepler star compact").attr("filter","url(#gaussblur2)")}else if("keplerP"===theme){var c=6,d=c*h/w;x.domain([-c/2,c/2]),y.domain([-d/2,d/2]);var m=["rgb(229, 24, 7)","rgb(251, 190, 2)"],n=d3.scale.linear().domain(d3.range(0,1.01,1/(m.length-1))).range(m),o=d3.scale.linear().domain(d3.extent(masses)).range([0,1]);d3.select("#starLayer").selectAll(".star.diffuse").data(pos).enter().append("circle").attr("cx",function(a){return x(a[0])}).attr("cy",function(a){return y(a[1])}).attr("r",function(a,b){return masses[b]>.01?37*Math.sqrt(masses[b]/d3.max(masses)):3}).attr("fill",function(a,b){return masses[b]>.01?n(o(masses[b])):"rgb(6, 16, 74)"}).attr("opacity",.8).attr("class","kepler star diffuse").attr("filter","url(#gaussblur2)"),d3.select("#starLayer").selectAll(".star.solid").data(pos).enter().append("circle").attr("cx",function(a){return x(a[0])}).attr("cy",function(a){return y(a[1])}).attr("r",function(a,b){return masses[b]>.01?32*Math.sqrt(masses[b]/d3.max(masses)):4}).attr("fill",function(a,b){return masses[b]>.01?n(o(masses[b])):"rgb(6, 16, 74)"}).attr("opacity",function(a,b){return masses[b]>.01?.9:1}).attr("stroke","rgb(163, 182, 247)").attr("stroke-width",function(a,b){return masses[b]>.01?"0px":"0.5px"}).attr("class","kepler star solid"),d3.select("#starLayer").selectAll(".star.compact").data(pos).enter().append("circle").attr("cx",function(a){return x(a[0])}).attr("cy",function(a){return y(a[1])}).attr("r",function(a,b){return masses[b]>.01?9*Math.sqrt(masses[b]/d3.max(masses)):0}).attr("fill","rgba(255, 255, 255, .9)").attr("class","kepler star compact").attr("filter","url(#gaussblur2)")}},transitionStars=function(a){if("jeffers"===theme){var b,c;for(b=0;nStars>b;b++)for(c=0;11>c;c++)starApexes[b][c][0]=apexStorage[b][c][0]+pos[b][0],starApexes[b][c][1]=apexStorage[b][c][1]+pos[b][1];d3.selectAll(".star").transition().ease("linear").attr("d",lineFunction).duration(a)}else"kepler"===theme?d3.selectAll(".star").transition().ease("linear").attr("cx",function(a){return x(a[0])}).attr("cy",function(a){return y(a[1])}).duration(a):"keplerP"===theme&&(d3.selectAll(".star.solid, .star.diffuse .trail").sort(function(a,b){return a[2]<b[2]-.01?-1:1}),d3.selectAll(".star").transition().ease("linear").attr("cx",function(a){return x(a[0])}).attr("cy",function(a){return y(a[1])}).duration(a))},setBackgroundImage=function(){var a;"jeffers"===theme?a="images/htcas_2.jpg":("kepler"===theme||"keplerP"===theme)&&(a="images/purple-nebula.jpg"),d3.select("#backgroundImage").attr("xlink:href",a)};